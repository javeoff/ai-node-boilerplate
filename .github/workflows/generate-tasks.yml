name: Generate Project Tasks
on:
  workflow_dispatch: # Manual trigger

permissions:
  issues: write
  contents: read

jobs:
  generate-tasks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate tasks using Aider
        id: aider
        uses: javeoff/aider-github-actions/ask@main
        with:
          model: openrouter/anthropic/claude-3.5-sonnet
          prompt: |
            Analyze the project code and suggest 5-10 tasks for improvements and new features.
            Start each task with a number and dot (e.g. "1.", "2." etc.).
            Each task should be specific and implementable.
            Describe each task in 1-2 sentences.
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

      - name: Create GitHub Issues
        uses: actions/github-script@v7
        with:
          script: |
            const aiderOutput = `${{ steps.aider.outputs.response }}`;
            
            // Look for tasks matching pattern "number. text"
            const tasks = aiderOutput.match(/\d+\.\s+[^\n]+/g);
            
            if (!tasks) {
              console.log('No tasks found in the output');
              return;
            }
            
            for (const task of tasks) {
              const taskText = task.replace(/^\d+\.\s+/, ''); // Remove number prefix
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: taskText,
                body: `Generated by Aider\n\nOriginal task: ${task}`,
                labels: ['enhancement']
              });
              
              console.log(`Created issue: ${taskText}`);
            }
